{% extends 'core/base.html' %}
{% load crispy_forms_tags %}

{% block title %} Add Images {% endblock %}

{% block content %}
<div class="container">
  <h2>Add Images for "{{ property.title }}"</h2>
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    {{ formset.management_form }}
    <div class="image-upload-container">
      {% for form in formset %}
        <div class="image-upload mb-3">
          <h4>Image {{ forloop.counter }}</h4>
          <label for="id_{{ forloop.counter0 }}_image" class="image-label">
            <div class="upload-placeholder" id="image-preview-{{ forloop.counter }}">
              <i class="bi bi-upload" style="font-size: 2rem;"></i>
              <p>Click or drag to upload image {{ forloop.counter }}</p>
            </div>
          </label>
          {{ form.image }}
          <button type="button" class="close-button" id="close-image-{{ forloop.counter }}" style="display:none;">&times;</button>
        </div>
        <script>
          document.getElementById('id_{{ forloop.counter0 }}_image').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview-{{ forloop.counter }}');
            const closeButton = document.getElementById('close-image-{{ forloop.counter }}');

            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Image preview" style="width: 100%; height: 100%;" />`;
                closeButton.style.display = 'block';
              };
              reader.readAsDataURL(file);
            } else {
              preview.innerHTML = '<i class="bi bi-upload" style="font-size: 2rem;"></i>';
              closeButton.style.display = 'none';
            }

            closeButton.addEventListener('click', function () {
              event.target.value = '';
              preview.innerHTML = '<i class="bi bi-upload" style="font-size: 2rem;"></i>';
              closeButton.style.display = 'none';
            });
          });
        </script>
      {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">Add Images</button>
  </form>
  <a href="{% url 'property_details' property.id %}">Back to Property Details</a>
</div>
{% endblock %}
